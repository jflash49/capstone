<?php

namespace Capstone\ReportBundle\Controller;

use Symfony\Bundle\FrameworkBundle\Controller\Controller;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\HttpFoundation\Resquest;
use Sensio\Bundle\FrameworkExtraBundle\Configuration\Route;
use Sensio\Bundle\FrameworkExtraBundle\Configuration\Template;

use Doctrine\ORM\Query\ResultSetMapping;

/**
 * Report Controller
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class ReportController extends Controller
{
	/**
	 * @Route("/school/{school}",name="school_report")
	 *  
	 * @return FilterBySchool
	 */
	public function schoolAction($school) {
		
		$em = $this->getDoctrine()->getManager();
		$report = $em->getRepository('SetupBundle:UserInfo')->findBySchool($school);
		if (!$report){
			throw $this->createNotFoundException(
				'No School found for school '.$school
				);
			}
		
		return $this->render('ReportBundle::school.html.twig', array('school' => $report, 'name'=>'School'));
	}
	/**
	 * @Route("/region/{region}",name="region_report")
	 * 
	 */
	public function regionAction($region) {
		$em = $this->getDoctrine()->getManager();
		$report = $em->getRepository('SetupBundle:School')->findRegion($region);
		if (!$report){
			throw $this->createNotFoundException(
				'No Data found for Region '.$region
				);
			}
	
		return $this->render('ReportBundle::region.html.twig', array('region' => $report, 'name'=>'Region'));
	}
	/**
	 * @Route("/class/{class}",name="class_report")
	 * 
	 */
	public function classAction($class) {
		$em = $this->getDoctrine()->getManager();
		$report = $em->getRepository("SetupBundle:UserInfo")->findByClass($class);
		if (!$report){
			throw $this->createNotFoundException(
				'No Data found for Class '.$class
				);
			}
	
		return $this->render('ReportBundle::class.html.twig', array('class' => $report, 'name'=>'Class'));
	}
	
	/**
	 * @Route("/overallscore/{id}",name="result_report")
	 * 
	 */
	public function resultAction($id) {
		$rsm = new ResultSetMapping();
		$rsm->addScalarResult('amount', 'a');
		$rsm->addScalarResult('total','t');
		$em = $this->getDoctrine()->getManager();
		$verbalr = $em->getRepository('SetupBundle:QuizQuestion')->findScoreByType($id,'verbal',$rsm);
		$mathr= $em->getRepository('SetupBundle:QuizQuestion')->findScoreByType($id,'mathematical',$rsm);
		$spatialr= $em->getRepository('SetupBundle:QuizQuestion')->findScoreByType($id,'spatial',$rsm);
		$visualr = $em->getRepository('SetupBundle:QuizQuestion')->findScoreByType($id,'visualization',$rsm);
		$classifyr= $em->getRepository('SetupBundle:QuizQuestion')->findScoreByType($id,'classification',$rsm);
		$logicr = $em->getRepository('SetupBundle:QuizQuestion')->findScoreByType($id,'logic',$rsm);
		$patternr = $em->getRepository('SetupBundle:QuizQuestion')->findScoreByType($id,'pattern recognition',$rsm);
		
		$verbal = implode(",",$verbalr[0]);	
		$math = implode(",",$mathr[0]);
		$spatial = implode(",",$spatialr[0]);
		$visual = implode(",",$visualr [0]);
		$classify = implode(",",$classifyr[0]);
		$logic = implode(",",$logicr[0]);
		$pattern = implode(",", $patternr[0]);
		
		if ((!$verbalr) ||(!$mathr)||(!$visualr)||(!$classifyr)||(!$patternr)||(!$logicr)||(!$spatialr)){
			throw $this->createNotFoundException(
				'No Data found for Person'
				);
			}	
		return $this->render('ReportBundle::user.html.twig', array(
				'verbal' => $verbal, 
				'math'=>  $math ,
				'visual'=> $visual,
				'classify'=>$classify,
				'pattern' => $pattern,
				'logic'=>$logic,
				'spatial'=>$spatial,
				'name'=>'User Result'));
	}
	/**
	 * @Route("/regional/",name="regional_report")
	 * 
	 */
	public function regionalAction() {
		$em = $this->getDoctrine()->getManager();
		$report = $em->getRepository("SetupBundle:UserInfo")->findRegionalResult();
		if (!$report){
			throw $this->createNotFoundException(
				'No Data found for Regional Participation'
				);
			}
	
		return $this->render('ReportBundle::regional.html.twig', array('regional' => $report, 'name'=>'Regional'));
	}
} 
